#include <libdragon.h>

#include "fonts.h"
#include "utils/fs.h"

typedef struct {
    color_t style[7];
} font_theme_t;

static rdpq_font_t *default_font = NULL;

static const font_theme_t font_themes[] = {
    {
        .style = {
            RGBA32(0xFF, 0xFF, 0xFF, 0xFF), // default
            RGBA32(0x70, 0xFF, 0x70, 0xFF), // green
            RGBA32(0x70, 0xBC, 0xFF, 0xFF), // blue
            RGBA32(0xFF, 0xFF, 0x70, 0xFF), // yellow
            RGBA32(0xFF, 0x99, 0x00, 0xFF), // orange
            RGBA32(0xFF, 0x40, 0x40, 0xFF), // red
            RGBA32(0xA0, 0xA0, 0xA0, 0xFF), // gray
        },
    },
    {
        // Solarized-inspired
        .style = {
            RGBA32(0xEE, 0xE8, 0xD5, 0xFF),
            RGBA32(0x85, 0x99, 0x00, 0xFF),
            RGBA32(0x26, 0x8B, 0xD2, 0xFF),
            RGBA32(0xB5, 0x89, 0x00, 0xFF),
            RGBA32(0xCB, 0x4B, 0x16, 0xFF),
            RGBA32(0xDC, 0x32, 0x2F, 0xFF),
            RGBA32(0x93, 0xA1, 0xA1, 0xFF),
        },
    },
    {
        // Gruvbox-inspired
        .style = {
            RGBA32(0xEB, 0xDB, 0xB2, 0xFF),
            RGBA32(0xB8, 0xBB, 0x26, 0xFF),
            RGBA32(0x83, 0xA5, 0x98, 0xFF),
            RGBA32(0xFA, 0xBD, 0x2F, 0xFF),
            RGBA32(0xFE, 0x80, 0x19, 0xFF),
            RGBA32(0xFB, 0x49, 0x34, 0xFF),
            RGBA32(0xA8, 0x99, 0x84, 0xFF),
        },
    },
    {
        // CRT Green
        .style = {
            RGBA32(0x9C, 0xFF, 0x9C, 0xFF),
            RGBA32(0x57, 0xFF, 0x57, 0xFF),
            RGBA32(0x7A, 0xFF, 0x7A, 0xFF),
            RGBA32(0xD0, 0xFF, 0x7A, 0xFF),
            RGBA32(0x9C, 0xFF, 0x57, 0xFF),
            RGBA32(0xFF, 0x7A, 0x7A, 0xFF),
            RGBA32(0x66, 0xAA, 0x66, 0xFF),
        },
    },
    {
        // Retrowave
        .style = {
            RGBA32(0xFF, 0xD6, 0xF3, 0xFF),
            RGBA32(0x6E, 0xFF, 0xB8, 0xFF),
            RGBA32(0x61, 0xDA, 0xFF, 0xFF),
            RGBA32(0xFF, 0xE0, 0x66, 0xFF),
            RGBA32(0xFF, 0x9D, 0x00, 0xFF),
            RGBA32(0xFF, 0x69, 0xA8, 0xFF),
            RGBA32(0xB6, 0x9A, 0xD8, 0xFF),
        },
    },
    {
        // Nord
        .style = {
            RGBA32(0xEC, 0xEF, 0xF4, 0xFF),
            RGBA32(0xA3, 0xBE, 0x8C, 0xFF),
            RGBA32(0x81, 0xA1, 0xC1, 0xFF),
            RGBA32(0xEB, 0xCB, 0x8B, 0xFF),
            RGBA32(0xD0, 0x87, 0x70, 0xFF),
            RGBA32(0xBF, 0x61, 0x6A, 0xFF),
            RGBA32(0x4C, 0x56, 0x6A, 0xFF),
        },
    },
    {
        // Dracula
        .style = {
            RGBA32(0xF8, 0xF8, 0xF2, 0xFF),
            RGBA32(0x50, 0xFA, 0x7B, 0xFF),
            RGBA32(0x8B, 0xE9, 0xFD, 0xFF),
            RGBA32(0xF1, 0xFA, 0x8C, 0xFF),
            RGBA32(0xFF, 0xB8, 0x6C, 0xFF),
            RGBA32(0xFF, 0x55, 0x55, 0xFF),
            RGBA32(0xBD, 0x93, 0xF9, 0xFF),
        },
    },
    {
        // Amber Terminal
        .style = {
            RGBA32(0xFF, 0xE2, 0xA8, 0xFF),
            RGBA32(0xFF, 0xC8, 0x5A, 0xFF),
            RGBA32(0xFF, 0xD9, 0x8A, 0xFF),
            RGBA32(0xFF, 0xEE, 0xA0, 0xFF),
            RGBA32(0xFF, 0xB0, 0x2E, 0xFF),
            RGBA32(0xFF, 0x7A, 0x2A, 0xFF),
            RGBA32(0xB8, 0x88, 0x44, 0xFF),
        },
    },
    {
        // Ocean Teal
        .style = {
            RGBA32(0xD2, 0xFF, 0xF3, 0xFF),
            RGBA32(0x68, 0xFF, 0xBF, 0xFF),
            RGBA32(0x6E, 0xE8, 0xFF, 0xFF),
            RGBA32(0xE8, 0xFF, 0x8A, 0xFF),
            RGBA32(0x00, 0xD5, 0xB8, 0xFF),
            RGBA32(0xFF, 0x6E, 0x7D, 0xFF),
            RGBA32(0x63, 0xA6, 0x9F, 0xFF),
        },
    },
    {
        // Monokai
        .style = {
            RGBA32(0xF8, 0xF8, 0xF2, 0xFF),
            RGBA32(0xA6, 0xE2, 0x2E, 0xFF),
            RGBA32(0x66, 0xD9, 0xEF, 0xFF),
            RGBA32(0xE6, 0xDB, 0x74, 0xFF),
            RGBA32(0xFD, 0x97, 0x1F, 0xFF),
            RGBA32(0xF9, 0x26, 0x72, 0xFF),
            RGBA32(0x75, 0x71, 0x5E, 0xFF),
        },
    },
    {
        // One Dark
        .style = {
            RGBA32(0xAB, 0xB2, 0xBF, 0xFF),
            RGBA32(0x98, 0xC3, 0x79, 0xFF),
            RGBA32(0x61, 0xAF, 0xEF, 0xFF),
            RGBA32(0xE5, 0xC0, 0x7B, 0xFF),
            RGBA32(0xD1, 0x9A, 0x66, 0xFF),
            RGBA32(0xE0, 0x6C, 0x75, 0xFF),
            RGBA32(0x5C, 0x63, 0x70, 0xFF),
        },
    },
    {
        // Tokyo Night
        .style = {
            RGBA32(0xC0, 0xCA, 0xF5, 0xFF),
            RGBA32(0x9E, 0xCE, 0x6A, 0xFF),
            RGBA32(0x7A, 0xA2, 0xF7, 0xFF),
            RGBA32(0xE0, 0xAF, 0x68, 0xFF),
            RGBA32(0xFF, 0x9E, 0x64, 0xFF),
            RGBA32(0xF7, 0x76, 0x8E, 0xFF),
            RGBA32(0x56, 0x5F, 0x89, 0xFF),
        },
    },
    {
        // Catppuccin Mocha
        .style = {
            RGBA32(0xCD, 0xD6, 0xF4, 0xFF),
            RGBA32(0xA6, 0xE3, 0xA1, 0xFF),
            RGBA32(0x89, 0xB4, 0xFA, 0xFF),
            RGBA32(0xF9, 0xE2, 0xAF, 0xFF),
            RGBA32(0xFA, 0xB3, 0x87, 0xFF),
            RGBA32(0xF3, 0x8B, 0xA8, 0xFF),
            RGBA32(0x6C, 0x70, 0x86, 0xFF),
        },
    },
};

void fonts_set_theme(int theme_id) {
    if (!default_font) {
        return;
    }

    int max_theme = (int)(sizeof(font_themes) / sizeof(font_themes[0])) - 1;
    if (theme_id < 0 || theme_id > max_theme) {
        theme_id = 0;
    }

    for (int i = 0; i <= STL_GRAY; i++) {
        rdpq_font_style(default_font, i, &((rdpq_fontstyle_t){ .color = font_themes[theme_id].style[i] }));
    }
}

static void load_default_font (char *custom_font_path) {
    char *font_path = "rom:/Firple-Bold.font64";

    if (custom_font_path && file_exists(custom_font_path)) {
        font_path = custom_font_path;
    }

    default_font = rdpq_font_load(font_path);
    fonts_set_theme(0);

    rdpq_text_register_font(FNT_DEFAULT, default_font);
}


void fonts_init (char *custom_font_path) {
    load_default_font(custom_font_path);
}
